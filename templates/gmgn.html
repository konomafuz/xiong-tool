{% extends "base.html" %}

{% block title %}åœ°å€å¤‡æ³¨å·¥å…·{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="text-center mb-4">
                <h2 class="gradient-text">
                    <i class="fas fa-tags me-2"></i>åœ°å€å¤‡æ³¨å·¥å…·
                </h2>
                <p class="text-muted">ä¸ºGMGN/OKXé’±åŒ…åœ°å€ç”Ÿæˆä¸“ä¸šå¤‡æ³¨æ ‡è®°</p>
            </div>

            <!-- å‚æ•°è®¾ç½®è¡¨å• -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>å‚æ•°è®¾ç½®
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="remarkForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">CAåœ°å€</label>
                                <input type="text" name="caAddress" class="form-control" 
                                       value="{{ request.form.get('caAddress', '') }}" 
                                       placeholder="è¾“å…¥ä»£å¸åˆçº¦åœ°å€" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">CAåç§°</label>
                                <input type="text" name="caName" class="form-control" 
                                       value="{{ request.form.get('caName', '') }}" 
                                       placeholder="è¾“å…¥ä»£å¸åç§°" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Top Holders æ•°é‡</label>
                                <input type="number" name="holderCount" class="form-control" 
                                       min="1" max="200" 
                                       value="{{ request.form.get('holderCount', '100') }}" 
                                       placeholder="æœ€å¤š200ä¸ª">
                                <small class="text-muted">è·å–å‰Nä¸ªæŒä»“åœ°å€</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Top Traders æ•°é‡</label>
                                <input type="number" name="traderCount" class="form-control" 
                                       min="1" max="200" 
                                       value="{{ request.form.get('traderCount', '100') }}" 
                                       placeholder="æœ€å¤š200ä¸ª">
                                <small class="text-muted">è·å–å‰Nä¸ªäº¤æ˜“è€…</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">é“¾ID</label>
                                <select name="chainId" class="form-select">
                                    <option value="501" {{ 'selected' if request.form.get('chainId', '501') == '501' }}>Solana (501)</option>
                                    <option value="1" {{ 'selected' if request.form.get('chainId') == '1' }}>Ethereum (1)</option>
                                </select>
                            </div>
                        </div>

                        <!-- é˜´è°‹é’±åŒ…æ£€æµ‹è®¾ç½® -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="conspiracyCheck" 
                                           id="conspiracyCheck" 
                                           {{ 'checked' if request.form.get('conspiracyCheck') }}>
                                    <label class="form-check-label fw-bold" for="conspiracyCheck">
                                        å¯ç”¨é˜´è°‹é’±åŒ…æ£€æµ‹
                                    </label>
                                </div>
                                <small class="text-muted">æ£€æµ‹ç–‘ä¼¼æ–°å»ºçš„é˜´è°‹é’±åŒ…</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">æ£€æµ‹å¤©æ•°</label>
                                <input type="number" name="conspiracyDays" class="form-control" 
                                       min="1" max="30" 
                                       value="{{ request.form.get('conspiracyDays', '10') }}" 
                                       placeholder="æ£€æŸ¥å¤šå°‘å¤©å‰çš„æ•°æ®">
                                <small class="text-muted">æ£€æŸ¥Nå¤©å‰æ˜¯å¦æœ‰äº¤æ˜“è®°å½•</small>
                            </div>
                        </div>

                        <!-- å·²æœ‰å¤‡æ³¨åœ°å€å¯¼å…¥ -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-file-import me-2"></i>å·²æœ‰å¤‡æ³¨åœ°å€å¯¼å…¥ (å¯é€‰)
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">å·²æœ‰å¤‡æ³¨åœ°å€</label>
                                            <textarea name="existingRemarks" class="form-control" rows="8" 
                                                      placeholder="æ”¯æŒä¸¤ç§æ ¼å¼ï¼š&#10;&#10;1. åœ°å€:å¤‡æ³¨æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰&#10;0x1234...abcd:KOLé’±åŒ…&#10;0x5678...efgh:åº„å®¶åœ°å€&#10;&#10;2. JSONæ ¼å¼&#10;[{&quot;address&quot;: &quot;7ukECzatL5uW4pEN8yd4ECoibYW3PxMxvh1FQojSm6yC&quot;, &quot;name&quot;: &quot;ğŸ’å‘¨40%-å‘¨ç›ˆåˆ©0.2M-æ€»0.7M&quot;}, {&quot;address&quot;: &quot;3WLcdAXodTV3kGHVqSmZxsFXga1gD1h3AaLmHEUXuHN2&quot;, &quot;name&quot;: &quot;æƒ å­4&quot;}]">{{ request.form.get('existingRemarks', '') }}</textarea>
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                æ”¯æŒä¸¤ç§æ ¼å¼ï¼š1) åœ°å€:å¤‡æ³¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰2) JSONæ•°ç»„æ ¼å¼ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ ¼å¼å¹¶ä¸æ–°ç”Ÿæˆçš„å¤‡æ³¨è¿›è¡Œå¯¹æ¯”å’Œåˆå¹¶ã€‚
                                            </small>
                                        </div>
                                        
                                        <!-- å¿«é€Ÿç¤ºä¾‹æŒ‰é’® -->
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                    onclick="fillExampleRemarks()">
                                                <i class="fas fa-clipboard me-1"></i>å¡«å…¥JSONæ ¼å¼ç¤ºä¾‹
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" 
                                                    onclick="fillTextFormatExample()">
                                                <i class="fas fa-list me-1"></i>å¡«å…¥æ–‡æœ¬æ ¼å¼ç¤ºä¾‹
                                            </button>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="mergeStrategy" 
                                                           value="keep_existing" id="keepExisting" checked>
                                                    <label class="form-check-label" for="keepExisting">
                                                        <strong>ä¿ç•™å·²æœ‰å¤‡æ³¨</strong> - æœ‰å†²çªæ—¶ä¼˜å…ˆä½¿ç”¨å·²æœ‰å¤‡æ³¨
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="mergeStrategy" 
                                                           value="keep_new" id="keepNew">
                                                    <label class="form-check-label" for="keepNew">
                                                        <strong>ä½¿ç”¨æ–°å¤‡æ³¨</strong> - æœ‰å†²çªæ—¶ä¼˜å…ˆä½¿ç”¨æ–°ç”Ÿæˆçš„å¤‡æ³¨
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-lg btn-gradient px-5">
                                <i class="fas fa-play me-2"></i>å¼€å§‹åˆ†æ
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div id="progressContainer" class="card shadow-sm mb-4" style="display: none;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">åˆ†æè¿›åº¦</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div id="progressBar" class="progress-bar bg-gradient" 
                             role="progressbar" style="width: 0%">
                        </div>
                    </div>
                    <div id="progressStatus" class="text-muted mt-2">å‡†å¤‡å¼€å§‹...</div>
                </div>
            </div>

            <!-- åœ°å€å¤‡æ³¨å†²çªå¤„ç†åŒº -->
            {% if session.get('address_conflicts') %}
            <div class="card shadow-sm mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>åœ°å€å¤‡æ³¨å†²çªå¤„ç†
                    </h5>
                    <p class="mb-0 small">å‘ç° {{ session['address_conflicts']|length }} ä¸ªåœ°å€çš„å¤‡æ³¨å­˜åœ¨å†²çªï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ï¼š</p>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('resolve_conflicts') }}">
                        {% for conflict in session['address_conflicts'] %}
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-wallet me-2"></i>
                                    {{ conflict.address }}
                                    {% if conflict.is_conspiracy %}
                                    <span class="badge bg-danger">é˜´è°‹é’±åŒ…</span>
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" 
                                                   name="conflict_{{ loop.index0 }}" 
                                                   value="existing" id="existing_{{ loop.index0 }}" checked>
                                            <label class="form-check-label" for="existing_{{ loop.index0 }}">
                                                <strong>ä½¿ç”¨å·²æœ‰å¤‡æ³¨ï¼š</strong><br>
                                                <span class="badge bg-info">{{ conflict.existing_remark }}</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" 
                                                   name="conflict_{{ loop.index0 }}" 
                                                   value="new" id="new_{{ loop.index0 }}">
                                            <label class="form-check-label" for="new_{{ loop.index0 }}">
                                                <strong>ä½¿ç”¨æ–°å¤‡æ³¨ï¼š</strong><br>
                                                <span class="badge bg-success">{{ conflict.new_remark }}</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-check me-2"></i>ç¡®è®¤é€‰æ‹©
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="ignoreConflicts()">
                                <i class="fas fa-times me-2"></i>å¿½ç•¥å†²çª
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- ç»“æœå±•ç¤ºåŒº -->
            {% if normal_remarks or conspiracy_remarks %}
            <div class="card shadow-sm">
                <div class="card-header bg-gradient text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list-alt me-2"></i>å¤‡æ³¨ç»“æœ
                        </h5>
                        <!-- ä¸‹è½½æŒ‰é’® -->
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" 
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-download me-1"></i>å¯¼å‡º
                            </button>
                            <ul class="dropdown-menu">
                                <li><h6 class="dropdown-header">å¯¼å‡ºèŒƒå›´</h6></li>
                                <li>
                                    <button class="dropdown-item" onclick="exportData('all', 'excel')">
                                        <i class="fas fa-file-excel me-2"></i>å…¨éƒ¨æ•°æ® (Excel)
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" onclick="exportData('normal', 'excel')">
                                        <i class="fas fa-user me-2"></i>æ™®é€šå¤‡æ³¨ (Excel)
                                    </button>
                                </li>
                                {% if conspiracy_remarks %}
                                <li>
                                    <button class="dropdown-item" onclick="exportData('conspiracy', 'excel')">
                                        <i class="fas fa-fish me-2"></i>é˜´è°‹é’±åŒ… (Excel)
                                    </button>
                                </li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li><h6 class="dropdown-header">æ–‡æœ¬æ ¼å¼</h6></li>
                                <li>
                                    <button class="dropdown-item" onclick="exportData('all', 'txt')">
                                        <i class="fas fa-file-alt me-2"></i>å…¨éƒ¨æ•°æ® (TXT)
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Tabå¯¼èˆª -->
                    <ul class="nav nav-tabs" id="remarksTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="normal-tab" data-bs-toggle="tab" 
                                    data-bs-target="#normal" type="button" role="tab">
                                <i class="fas fa-user me-2"></i>
                                æ™®é€šå¤‡æ³¨ 
                                <span class="badge bg-primary ms-1">{{ normal_remarks|length }}</span>
                            </button>
                        </li>
                        {% if conspiracy_remarks %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="conspiracy-tab" data-bs-toggle="tab" 
                                    data-bs-target="#conspiracy" type="button" role="tab">
                                <i class="fas fa-fish me-2"></i>
                                é˜´è°‹é’±åŒ…å¤‡æ³¨ 
                                <span class="badge bg-warning ms-1">{{ conspiracy_remarks|length }}</span>
                            </button>
                        </li>
                        {% endif %}
                    </ul>

                    <!-- Tabå†…å®¹ -->
                    <div class="tab-content" id="remarksTabContent">
                        <!-- æ™®é€šå¤‡æ³¨ -->
                        <div class="tab-pane fade show active" id="normal" role="tabpanel">
                            <div class="p-3">
                                {% if normal_remarks %}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-muted mb-0">å…± {{ normal_remarks|length }} ä¸ªæ™®é€šåœ°å€</h6>
                                    <button class="btn btn-sm btn-outline-primary" onclick="copyAllRemarks('normal')">
                                        <i class="fas fa-copy me-1"></i>å¤åˆ¶å…¨éƒ¨
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="5%">#</th>
                                                <th width="35%">åœ°å€</th>
                                                <th width="50%">å¤‡æ³¨</th>
                                                <th width="10%">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in normal_remarks %}
                                            <tr>
                                                <td>{{ loop.index }}</td>
                                                <td>
                                                    <code class="address-text">{{ item.address }}</code>
                                                </td>
                                                <td>
                                                    <span class="remark-text">{{ item.remark }}</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-secondary" 
                                                            onclick="copySingleRemark('{{ item.address }}', '{{ item.remark|replace("'", "\\'") }}')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>æš‚æ— æ™®é€šåœ°å€å¤‡æ³¨</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- é˜´è°‹é’±åŒ…å¤‡æ³¨ -->
                        {% if conspiracy_remarks %}
                        <div class="tab-pane fade" id="conspiracy" role="tabpanel">
                            <div class="p-3">
                                <div class="alert alert-warning" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>é˜´è°‹é’±åŒ…æç¤ºï¼š</strong> ä»¥ä¸‹åœ°å€ç–‘ä¼¼æ–°å»ºçš„é˜´è°‹é’±åŒ…ï¼ŒæŠ•èµ„æ—¶è¯·è°¨æ…è€ƒè™‘
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-muted mb-0">å…± {{ conspiracy_remarks|length }} ä¸ªé˜´è°‹é’±åŒ…</h6>
                                    <button class="btn btn-sm btn-outline-warning" onclick="copyAllRemarks('conspiracy')">
                                        <i class="fas fa-copy me-1"></i>å¤åˆ¶å…¨éƒ¨
                                    </button>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-warning">
                                            <tr>
                                                <th width="5%">#</th>
                                                <th width="35%">åœ°å€</th>
                                                <th width="50%">å¤‡æ³¨</th>
                                                <th width="10%">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in conspiracy_remarks %}
                                            <tr class="table-warning">
                                                <td>{{ loop.index }}</td>
                                                <td>
                                                    <code class="address-text">{{ item.address }}</code>
                                                </td>
                                                <td>
                                                    <span class="remark-text fw-bold text-danger">{{ item.remark }}</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            onclick="copySingleRemark('{{ item.address }}', '{{ item.remark|replace("'", "\\'") }}')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- éšè—çš„æ•°æ®å­˜å‚¨ -->
<script id="normalRemarksData" type="application/json">
    {{ normal_remarks | tojson if normal_remarks else '[]' }}
</script>

<script id="conspiracyRemarksData" type="application/json">
    {{ conspiracy_remarks | tojson if conspiracy_remarks else '[]' }}
</script>

<style>
/* æ¸å˜æ–‡å­— */
.gradient-text {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* æ¸å˜èƒŒæ™¯ */
.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* æ¸å˜æŒ‰é’® */
.btn-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    transition: all 0.3s ease;
}

.btn-gradient:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    color: white;
}

/* åœ°å€æ–‡å­—æ ·å¼ */
.address-text {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 4px;
    word-break: break-all;
}

/* å¤‡æ³¨æ–‡å­—æ ·å¼ */
.remark-text {
    font-weight: 500;
    color: #495057;
}

/* è¡¨æ ¼æ‚¬åœæ•ˆæœ */
.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.1);
}

/* è¿›åº¦æ¡åŠ¨ç”» */
.progress-bar {
    transition: width 0.6s ease;
}

/* Tabæ ·å¼ä¼˜åŒ– */
.nav-tabs .nav-link {
    border-radius: 0;
    border: 1px solid transparent;
    color: #6c757d;
}

.nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: white;
}

/* å¡ç‰‡é˜´å½± */
.card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .address-text {
        font-size: 0.8em;
    }
    
    .table-responsive {
        font-size: 0.9em;
    }
}
</style>

<script>
// è·å–æ•°æ®
function getNormalRemarks() {
    try {
        const data = document.getElementById('normalRemarksData').textContent;
        return JSON.parse(data);
    } catch (e) {
        console.error('è§£ææ™®é€šå¤‡æ³¨æ•°æ®å¤±è´¥:', e);
        return [];
    }
}

function getConspiracyRemarks() {
    try {
        const data = document.getElementById('conspiracyRemarksData').textContent;
        return JSON.parse(data);
    } catch (e) {
        console.error('è§£æé˜´è°‹é’±åŒ…æ•°æ®å¤±è´¥:', e);
        return [];
    }
}

// å¤åˆ¶å•ä¸ªå¤‡æ³¨ - ä¿®æ”¹ä¸ºä½ è¦æ±‚çš„æ ¼å¼
function copySingleRemark(address, remark) {
    const text = address + ':' + remark;
    copyToClipboard(text, 'å•ä¸ªå¤‡æ³¨');
}

// å¤åˆ¶å…¨éƒ¨å¤‡æ³¨ - ä¿®æ”¹ä¸ºä½ è¦æ±‚çš„æ ¼å¼
function copyAllRemarks(type) {
    let remarks = [];
    
    if (type === 'normal') {
        const normalData = getNormalRemarks();
        normalData.forEach(item => {
            remarks.push(item.address + ':' + item.remark);
        });
    } else if (type === 'conspiracy') {
        const conspiracyData = getConspiracyRemarks();
        conspiracyData.forEach(item => {
            remarks.push(item.address + ':' + item.remark);
        });
    }
    
    // ç”¨é€—å·åˆ†éš”ï¼Œç»“å°¾ä¸åŠ é€—å·
    const text = remarks.join(',');
    copyToClipboard(text, `${remarks.length} æ¡å¤‡æ³¨`);
}

// ç»Ÿä¸€çš„å¤åˆ¶æ–¹æ³•ï¼ˆæ”¯æŒå¤šç§ç¯å¢ƒï¼‰
function copyToClipboard(text, description = 'å†…å®¹') {
    // æ–¹æ³•1ï¼šå°è¯•ç°ä»£ Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(`å¤åˆ¶æˆåŠŸï¼š${description}`, 'success');
        }).catch(() => {
            fallbackCopy(text, description);
        });
    } else {
        // æ–¹æ³•2ï¼šå›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
        fallbackCopy(text, description);
    }
}

// ä¼ ç»Ÿå¤åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹HTTPå’Œæ—§æµè§ˆå™¨ï¼‰
function fallbackCopy(text, description = 'å†…å®¹') {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.left = '-9999px';
    textarea.style.top = '0';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    
    try {
        textarea.focus();
        textarea.select();
        textarea.setSelectionRange(0, text.length);
        
        const success = document.execCommand('copy');
        if (success) {
            showToast(`å¤åˆ¶æˆåŠŸï¼š${description}`, 'success');
        } else {
            showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
        }
    } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'error');
        
        // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šé€‰ä¸­æ–‡æœ¬è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
        textarea.style.position = 'static';
        textarea.style.left = 'auto';
        textarea.style.opacity = '1';
        textarea.style.width = '100%';
        textarea.style.height = '100px';
        textarea.focus();
        textarea.select();
    } finally {
        setTimeout(() => {
            if (document.body.contains(textarea)) {
                document.body.removeChild(textarea);
            }
        }, 100);
    }
}

// å¯¼å‡ºæ•°æ®
function exportData(type, format) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/download_gmgn_remarks';
    form.style.display = 'none';
    
    const typeInput = document.createElement('input');
    typeInput.type = 'hidden';
    typeInput.name = 'remarkType';
    typeInput.value = type;
    
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'exportFormat';
    formatInput.value = format;
    
    form.appendChild(typeInput);
    form.appendChild(formatInput);
    document.body.appendChild(form);
    
    form.submit();
    document.body.removeChild(form);
}

// æç¤ºæ¶ˆæ¯
function showToast(message, type = 'success') {
    // ç§»é™¤å·²å­˜åœ¨çš„toast
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => toast.remove());
    
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1080';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    
    // ä½¿ç”¨Bootstrap Toastï¼ˆå¦‚æœå¯ç”¨ï¼‰æˆ–ç®€å•çš„æ˜¾ç¤º/éšè—
    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 3000
        });
        toast.show();
        
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    } else {
        // ç®€å•çš„æ˜¾ç¤º/éšè—
        toastElement.style.display = 'block';
        setTimeout(() => {
            toastElement.style.opacity = '0';
            setTimeout(() => {
                if (toastElement.parentNode) {
                    toastElement.remove();
                }
            }, 300);
        }, 3000);
    }
}

// è¡¨å•æäº¤æ—¶æ˜¾ç¤ºè¿›åº¦æ¡
document.getElementById('remarkForm').addEventListener('submit', function(e) {
    const conspiracyCheck = document.getElementById('conspiracyCheck').checked;
    
    if (conspiracyCheck) {
        // å¦‚æœå¯ç”¨äº†é˜´è°‹é’±åŒ…æ£€æµ‹ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡
        document.getElementById('progressContainer').style.display = 'block';
        simulateProgress();
    }
});

// æ¨¡æ‹Ÿè¿›åº¦æ¡
function simulateProgress() {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressStatus = document.getElementById('progressStatus');
    
    let progress = 0;
    const steps = [
        'è·å–æŒä»“æ•°æ®...',
        'è·å–äº¤æ˜“æ•°æ®...',
        'æ£€æµ‹é˜´è°‹é’±åŒ…...',
        'ç”Ÿæˆå¤‡æ³¨...',
        'å®Œæˆåˆ†æ'
    ];
    
    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        
        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';
        
        const stepIndex = Math.floor((progress / 100) * steps.length);
        if (stepIndex < steps.length) {
            progressStatus.textContent = steps[stepIndex];
        }
        
        if (progress >= 100) {
            clearInterval(interval);
            progressStatus.textContent = 'åˆ†æå®Œæˆï¼';
        }
    }, 500);
}

// å¿½ç•¥å†²çª
function ignoreConflicts() {
    if (confirm('ç¡®å®šè¦å¿½ç•¥æ‰€æœ‰å†²çªå—ï¼Ÿè¿™å°†ä¿æŒå½“å‰çš„å¤‡æ³¨ç»“æœã€‚')) {
        // åˆ›å»ºä¸€ä¸ªè¡¨å•æ¥å‘é€POSTè¯·æ±‚
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/ignore_conflicts';
        document.body.appendChild(form);
        form.submit();
    }
}

// å¡«å…¥JSONæ ¼å¼ç¤ºä¾‹
function fillExampleRemarks() {
    const exampleJson = `[
  {
    "address": "7ukECzatL5uW4pEN8yd4ECoibYW3PxMxvh1FQojSm6yC",
    "name": "ğŸ’å‘¨40%-å‘¨ç›ˆåˆ©0.2M-æ€»0.7M"
  },
  {
    "address": "3WLcdAXodTV3kGHVqSmZxsFXga1gD1h3AaLmHEUXuHN2",
    "name": "æƒ å­4"
  }
]`;
    document.querySelector('textarea[name="existingRemarks"]').value = exampleJson;
}

// å¡«å…¥æ–‡æœ¬æ ¼å¼ç¤ºä¾‹
function fillTextFormatExample() {
    const exampleText = `7ukECzatL5uW4pEN8yd4ECoibYW3PxMxvh1FQojSm6yC:ğŸ’å‘¨40%-å‘¨ç›ˆåˆ©0.2M-æ€»0.7M
3WLcdAXodTV3kGHVqSmZxsFXga1gD1h3AaLmHEUXuHN2:æƒ å­4`;
    document.querySelector('textarea[name="existingRemarks"]').value = exampleText;
}

// é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥å¤åˆ¶åŠŸèƒ½å¯ç”¨æ€§
document.addEventListener('DOMContentLoaded', function() {
    console.log('Clipboard API æ”¯æŒ:', !!navigator.clipboard);
    console.log('å®‰å…¨ä¸Šä¸‹æ–‡:', window.isSecureContext);
    
    if (!navigator.clipboard && !window.isSecureContext) {
        console.warn('å½“å‰ç¯å¢ƒä¸æ”¯æŒç°ä»£å‰ªè´´æ¿APIï¼Œå°†ä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•');
    }
});
</script>
{% endblock %}