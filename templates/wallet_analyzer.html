{% extends "base.html" %}

{% block title %}é’±åŒ…åˆ†æå™¨ - Smart Money Tracker{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-11">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-primary text-white border-0">
                    <div class="row align-items-center">
                        <div class="col">
                            <h3 class="mb-0 fw-bold">
                                <i class="fas fa-brain me-3"></i>é’±åŒ…æ™ºèƒ½åˆ†æå™¨
                            </h3>
                            <small class="opacity-75">è‡ªåŠ¨è¯†åˆ«é’±åŒ…ç‰¹å¾å¹¶ç”Ÿæˆæ™ºèƒ½æ ‡ç­¾</small>
                        </div>
                        <div class="col-auto">
                            <div class="bg-white bg-opacity-20 rounded-pill px-3 py-1">
                                <i class="fas fa-tags me-2"></i>
                                <span class="small fw-semibold">æ™ºèƒ½æ ‡ç­¾ç³»ç»Ÿ</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    <!-- è¾“å…¥è¡¨å• -->
                    <form method="POST" action="{{ url_for('wallet_analyzer') }}" id="walletAnalyzerForm">
                        <div class="row g-4 mb-4">
                            <!-- é“¾é€‰æ‹© -->
                            <div class="col-md-2">
                                <label for="chainId" class="form-label fw-semibold text-muted">
                                    <i class="fas fa-link me-2"></i>åŒºå—é“¾
                                </label>
                                <select class="form-select shadow-sm" id="chainId" name="chainId" required>
                                    <option value="501" {{ 'selected' if chain_id == '501' else '' }}>ğŸŸ£ Solana</option>
                                    <option value="1" {{ 'selected' if chain_id == '1' else '' }}>ğŸ”µ Ethereum</option>
                                    <option value="56" {{ 'selected' if chain_id == '56' else '' }}>ğŸŸ¡ BSC</option>
                                </select>
                            </div>

                            <!-- å¤‡æ³¨å¤„ç†é€‰é¡¹ -->
                            <div class="col-md-2">
                                <label for="preserveRemarks" class="form-label fw-semibold text-muted">
                                    <i class="fas fa-comment me-2"></i>å¤‡æ³¨å¤„ç†
                                </label>
                                <select class="form-select shadow-sm" id="preserveRemarks" name="preserveRemarks">
                                    <option value="overwrite" {{ 'selected' if preserve_remarks == 'overwrite' else '' }}>è¦†ç›–åŸå¤‡æ³¨</option>
                                    <option value="append" {{ 'selected' if preserve_remarks == 'append' else '' }}>è¿½åŠ åˆ°åé¢</option>
                                    <option value="prepend">æ·»åŠ åˆ°å‰é¢</option>
                                </select>
                            </div>

                            <!-- åœ°å€è¾“å…¥ -->
                            <div class="col-md-6">
                                <label for="walletAddresses" class="form-label fw-semibold text-muted">
                                    <i class="fas fa-wallet me-2"></i>é’±åŒ…åœ°å€åˆ—è¡¨
                                </label>
                                <textarea class="form-control shadow-sm" 
                                         id="walletAddresses" 
                                         name="walletAddresses" 
                                         rows="4" 
                                         placeholder="æ”¯æŒæ ¼å¼ï¼š&#10;çº¯åœ°å€: 38tAutsiZWaJ8MsMJVgKCx4U5LHwZM2g6StmQpKLRqz6&#10;å¸¦å¤‡æ³¨: GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL:kori-æŒ2.6%&#10;å¤æ‚å¤‡æ³¨: WinLrk2oddUtCfyGsLo4ajjxZGy6pwzDugFiE5PJNiU:kori-æŒ1.7%-ç›ˆ122.7k" 
                                         required>{{ wallet_addresses or '' }}</textarea>
                                <div class="form-text text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>
                                    æ”¯æŒ <code>åœ°å€:å¤‡æ³¨</code> æ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œæœ€å¤š10ä¸ªåœ°å€
                                </div>
                            </div>

                            <!-- åˆ†ææŒ‰é’® -->
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100 shadow-sm">
                                    <i class="fas fa-magic me-2"></i>å¼€å§‹åˆ†æ
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- åˆ†æç»“æœ -->
                    {% if results %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-success border-0">
                                <h5 class="mb-2 text-success fw-bold">
                                    <i class="fas fa-check-circle me-2"></i>åˆ†æå®Œæˆ
                                </h5>
                                <p class="mb-0">æˆåŠŸåˆ†æäº† {{ results|length }} ä¸ªé’±åŒ…åœ°å€</p>
                            </div>
                        </div>
                    </div>

                    <!-- æ•°æ®æ ‡ç­¾é€‰æ‹©å™¨ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="fas fa-cogs me-2"></i>å…¨å±€æ•°æ®æ ‡ç­¾è®¾ç½®ï¼ˆæœ€å¤šé€‰æ‹©3ä¸ªï¼‰
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <h6 class="text-primary mb-2">
                                                <i class="fas fa-percentage me-1"></i>èƒœç‡æŒ‡æ ‡
                                            </h6>
                                            <div class="d-flex flex-wrap gap-2">
                                                <div class="form-check">
                                                    <input class="form-check-input global-data-checkbox" type="checkbox" 
                                                           value="win_rate_7d" id="globalWinRate7d">
                                                    <label class="form-check-label" for="globalWinRate7d">
                                                        7Dèƒœç‡
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input global-data-checkbox" type="checkbox" 
                                                           value="win_rate_30d" id="globalWinRate30d">
                                                    <label class="form-check-label" for="globalWinRate30d">
                                                        30Dèƒœç‡
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <h6 class="text-success mb-2">
                                                <i class="fas fa-coins me-1"></i>æ”¶ç›ŠæŒ‡æ ‡
                                            </h6>
                                            <div class="d-flex flex-wrap gap-2">
                                                <div class="form-check">
                                                    <input class="form-check-input global-data-checkbox" type="checkbox" 
                                                           value="pnl_7d" id="globalPnl7d">
                                                    <label class="form-check-label" for="globalPnl7d">
                                                        7Dæ”¶ç›Š
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input global-data-checkbox" type="checkbox" 
                                                           value="pnl_30d" id="globalPnl30d">
                                                    <label class="form-check-label" for="globalPnl30d">
                                                        30Dæ”¶ç›Š
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <h6 class="text-warning mb-2">
                                                <i class="fas fa-chart-line me-1"></i>ROIæŒ‡æ ‡
                                            </h6>
                                            <div class="d-flex flex-wrap gap-2">
                                                <div class="form-check">
                                                    <input class="form-check-input global-data-checkbox" type="checkbox" 
                                                           value="roi_7d" id="globalRoi7d">
                                                    <label class="form-check-label" for="globalRoi7d">
                                                        7D ROI
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input global-data-checkbox" type="checkbox" 
                                                           value="roi_30d" id="globalRoi30d">
                                                    <label class="form-check-label" for="globalRoi30d">
                                                        30D ROI
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="selected-count text-muted small">
                                                    å·²é€‰æ‹© <span id="selectedCount">0</span>/3 ä¸ªæŒ‡æ ‡
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearGlobalSelection()">
                                                        <i class="fas fa-eraser me-1"></i>æ¸…ç©ºé€‰æ‹©
                                                    </button>
                                                    <button type="button" class="btn btn-primary btn-sm" onclick="applyGlobalSelection()">
                                                        <i class="fas fa-check me-1"></i>åº”ç”¨åˆ°æ‰€æœ‰é’±åŒ…
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é’±åŒ…åˆ†æè¡¨æ ¼ -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h5 class="mb-0 fw-semibold text-dark">
                                        <i class="fas fa-table me-2"></i>é’±åŒ…æ ‡ç­¾åˆ†æ
                                    </h5>
                                </div>
                                <div class="col-auto d-flex gap-2">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="clearAllRemarks()">
                                        <i class="fas fa-eraser me-1"></i>æ¸…ç©ºæ‰€æœ‰å¤‡æ³¨
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="exportResults()">
                                        <i class="fas fa-download me-1"></i>å¯¼å‡ºç»“æœ
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="walletAnalysisTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="4%" class="fw-semibold">#</th>
                                            <th width="18%" class="fw-semibold">
                                                <i class="fas fa-wallet me-1"></i>é’±åŒ…åœ°å€
                                            </th>
                                            <th width="12%" class="fw-semibold">
                                                <i class="fas fa-dollar-sign me-1"></i>æŒä»“ä»·å€¼
                                            </th>
                                            <th width="24%" class="fw-semibold">
                                                <i class="fas fa-chart-line me-1"></i>å¤šç»´åº¦æ•°æ®
                                            </th>
                                            <th width="18%" class="fw-semibold">
                                                <i class="fas fa-robot me-1"></i>ç³»ç»Ÿæ ‡ç­¾
                                            </th>
                                            <th width="24%" class="fw-semibold">
                                                <i class="fas fa-comment me-1"></i>ç”Ÿæˆå¤‡æ³¨
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in results %}
                                        <tr data-address="{{ result.address }}" class="wallet-row">
                                            <td class="fw-bold text-primary">{{ loop.index }}</td>
                                            
                                            <!-- é’±åŒ…åœ°å€ -->
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="me-2">
                                                        <div class="wallet-avatar">
                                                            {{ result.address[:2] }}
                                                        </div>
                                                    </div>
                                                    <div class="flex-grow-1 min-width-0">
                                                        <code class="small fw-bold d-block text-truncate">{{ result.address[:8] }}...{{ result.address[-6:] }}</code>
                                                        <div class="small text-muted">{{ result.chain_id }}</div>
                                                        {% if result.stats.get('star_level') and result.stats.get('high_profit_tokens', 0) > 0 %}
                                                        <div class="small text-warning">
                                                            {{ result.stats.get('star_level') }} {{ result.stats.get('high_profit_tokens') }}å¸ç›ˆåˆ©>1w
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    <button class="btn btn-link btn-sm p-1" onclick="copyAddress('{{ result.address }}')" title="å¤åˆ¶åœ°å€">
                                                        <i class="fas fa-copy text-muted"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            
                                            <!-- æŒä»“ä»·å€¼ -->
                                            <td>
                                                {% if result.stats.total_balance_usd > 0 %}
                                                    <div class="balance-container">
                                                        <span class="balance-amount fw-bold">
                                                            {% if result.stats.total_balance_usd >= 1000000 %}
                                                                ${{ "%.2f"|format(result.stats.total_balance_usd / 1000000) }}M
                                                            {% elif result.stats.total_balance_usd >= 1000 %}
                                                                ${{ "%.0f"|format(result.stats.total_balance_usd / 1000) }}K
                                                            {% else %}
                                                                ${{ "%.0f"|format(result.stats.total_balance_usd) }}
                                                            {% endif %}
                                                        </span>
                                                        <div class="small text-muted">{{ result.stats.effective_token_count or 0 }} å¸</div>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted small">-</span>
                                                {% endif %}
                                            </td>
                                            
                                            <!-- å¤šç»´åº¦æ•°æ® -->
                                            <td>
                                                <div class="multi-data-container" data-address="{{ result.address }}">
                                                    <!-- èƒœç‡æ•°æ® -->
                                                    <div class="data-group mb-2">
                                                        <div class="data-label small text-muted fw-semibold">
                                                            <i class="fas fa-percentage me-1"></i>èƒœç‡
                                                        </div>
                                                        <div class="data-values d-flex gap-1">
                                                            {% set win_rates = result.stats.get('win_rates', {}) %}
                                                            <span class="data-chip" data-period="7d" data-type="win_rate" data-value="{{ win_rates.get('7d', 0) }}">
                                                                7D: {{ "%.1f"|format(win_rates.get('7d', 0)) }}%
                                                            </span>
                                                            <span class="data-chip" data-period="30d" data-type="win_rate" data-value="{{ win_rates.get('30d', 0) }}">
                                                                30D: {{ "%.1f"|format(win_rates.get('30d', 0)) }}%
                                                            </span>
                                                        </div>
                                                    </div>
                                                
                                                    <!-- æ”¶ç›Šæ•°æ® -->
                                                    <div class="data-group mb-2">
                                                        <div class="data-label small text-muted fw-semibold">
                                                            <i class="fas fa-coins me-1"></i>æ”¶ç›Š
                                                        </div>
                                                        <div class="data-values d-flex gap-1">
                                                            {% set total_pnls = result.stats.get('total_pnls', {}) %}
                                                            <span class="data-chip" data-period="7d" data-type="pnl" data-value="{{ total_pnls.get('7d', 0) }}">
                                                                7D: ${{ "%.0f"|format(total_pnls.get('7d', 0)) }}
                                                            </span>
                                                            <span class="data-chip" data-period="30d" data-type="pnl" data-value="{{ total_pnls.get('30d', 0) }}">
                                                                30D: ${{ "%.0f"|format(total_pnls.get('30d', 0)) }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                
                                                    <!-- ROIæ•°æ® -->
                                                    <div class="data-group">
                                                        <div class="data-label small text-muted fw-semibold">
                                                            <i class="fas fa-chart-line me-1"></i>ROI
                                                        </div>
                                                        <div class="data-values d-flex gap-1">
                                                            {% set total_rois = result.stats.get('total_rois', {}) %}
                                                            <span class="data-chip" data-period="7d" data-type="roi" data-value="{{ total_rois.get('7d', 0) }}">
                                                                7D: {{ "%.1f"|format(total_rois.get('7d', 0)) }}%
                                                            </span>
                                                            <span class="data-chip" data-period="30d" data-type="roi" data-value="{{ total_rois.get('30d', 0) }}">
                                                                30D: {{ "%.1f"|format(total_rois.get('30d', 0)) }}%
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            
                                            <!-- ç³»ç»Ÿæ ‡ç­¾ -->
                                            <td>
                                                <div class="d-flex flex-wrap gap-1 auto-tags-container" data-address="{{ result.address }}">
                                                    {% for tag in result.detected_tags %}
                                                    <span class="badge auto-tag" data-tag="{{ tag }}">
                                                        {% set tag_detail = result.tag_details.get(tag, {}) %}
                                                        {% if tag_detail.get('emoji') %}
                                                            <span class="tag-emoji">{{ tag_detail.get('emoji') }}</span>
                                                        {% endif %}
                                                        {{ tag }}
                                                    </span>
                                                    {% endfor %}
                                                </div>
                                            </td>
                                            
                                            <!-- ç”Ÿæˆå¤‡æ³¨ -->
                                            <td>
                                                <div class="remark-container">
                                                    <div class="input-group">
                                                        <input type="text" 
                                                               class="form-control form-control-sm remark-input" 
                                                               data-address="{{ result.address }}"
                                                               data-original-remark="{{ result.get('original_remark', '') }}"
                                                               data-balance-millions="{{ result.stats.get('balance_millions', 0) }}"
                                                               data-has-large-holding="{{ result.stats.get('has_large_holding', False)|lower }}"
                                                               placeholder="è‡ªåŠ¨ç”Ÿæˆ..."
                                                               maxlength="80">
                                                        <button class="btn btn-outline-secondary btn-sm" 
                                                                type="button" 
                                                                onclick="toggleRemarkMode('{{ result.address }}')"
                                                                title="ç¼–è¾‘/é”å®š">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                    </div>
                                                    <div class="form-text small d-flex justify-content-between">
                                                        <span class="char-count">0/80</span>
                                                        <span class="mode-indicator">è‡ªåŠ¨æ¨¡å¼</span>
                                                    </div>
                                                    
                                                    <!-- å·²é€‰æ‹©çš„æ•°æ®æŒ‡æ ‡ -->
                                                    <div class="selected-data-indicators mt-1" data-address="{{ result.address }}">
                                                        <!-- é€‰ä¸­çš„æ•°æ®æŒ‡æ ‡ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- æ ‡ç­¾è¯´æ˜é¢æ¿ -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-info-circle me-2"></i>æ ‡ç­¾è¯†åˆ«è§„åˆ™ & ä½¿ç”¨è¯´æ˜
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <h6 class="text-primary">ğŸ’° èµ„äº§ç‰¹å¾</h6>
                                            <ul class="small mb-0">
                                                <li><strong>å•å¸</strong>ï¼šæœ‰æ•ˆæŒä»“å¸ç§â‰¤3ä¸ª</li>
                                                <li><strong>æ–°</strong>ï¼šåˆ›å»ºæ—¶é—´â‰¤30å¤©</li>
                                                <li><strong>é’“é±¼</strong>ï¼šæŒæœ‰ä½†æœªè´­ä¹°çš„ä»£å¸</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-success">ğŸ“ˆ äº¤æ˜“ç‰¹å¾</h6>
                                            <ul class="small mb-0">
                                                <li><strong>é«˜é¢‘</strong>ï¼š7Däº¤æ˜“â‰¥200æ¬¡</li>
                                                <li><strong>ä½é¢‘</strong>ï¼š7Däº¤æ˜“1-199æ¬¡</li>
                                                <li><strong>ä¼‘çœ </strong>ï¼š30Dæ— äº¤æ˜“è®°å½•</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-warning">ğŸ§  æ™ºèƒ½ç‰¹å¾</h6>
                                            <ul class="small mb-0">
                                                <li><strong>ğŸ§ èªæ˜</strong>ï¼š7Dèƒœç‡â‰¥50%</li>
                                                <li><strong>ğŸ’¥æš´å‡»</strong>ï¼š7Dèƒœç‡<30%ä½†å•å¸>1ä¸‡åˆ€</li>
                                                <li><strong>ğŸ“ˆæ³¢æ®µ</strong>ï¼šå¤šçª—å£ç›ˆåˆ©+é«˜èƒœç‡</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-3">
                                            <h6 class="text-info">ğŸ“ å¤‡æ³¨æ ¼å¼</h6>
                                            <ul class="small mb-0">
                                                <li><strong>æ ¼å¼</strong>ï¼šå‰4ä½-æ•°æ®æ ‡ç­¾-å…¶ä»–æ ‡ç­¾</li>
                                                <li><strong>æŒä»“</strong>ï¼š>0.1Mè‡ªåŠ¨æ˜¾ç¤ºå…·ä½“Mæ•°</li>
                                                <li><strong>æ•°æ®</strong>ï¼šæœ€å¤šé€‰æ‹©3ä¸ªæŒ‡æ ‡</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ä¿æŒç°æœ‰æ ·å¼... */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.wallet-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 12px;
}

.balance-container {
    text-align: right;
}

.balance-amount {
    color: #28a745;
    font-size: 14px;
}

.auto-tag {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 12px;
    white-space: nowrap;
}

/* å¤šç»´åº¦æ•°æ®æ ·å¼ */
.multi-data-container {
    font-size: 11px;
}

.data-group {
    margin-bottom: 6px;
}

.data-label {
    margin-bottom: 3px;
    font-size: 10px;
    font-weight: 600;
}

.data-chip {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 10px;
    white-space: nowrap;
    transition: all 0.2s ease;
}

.data-chip.positive {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border-color: #28a745;
    color: #155724;
}

.data-chip.negative {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    border-color: #dc3545;
    color: #721c24;
}

.data-indicator-tag {
    background: linear-gradient(135deg, #17a2b8, #138496);
    color: white;
    border: none;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 8px;
    margin: 1px;
    cursor: pointer;
    display: inline-block;
}

.data-indicator-tag:hover {
    background: linear-gradient(135deg, #138496, #117a8b);
}

.data-indicator-tag .remove-indicator {
    margin-left: 3px;
    opacity: 0.7;
}

.data-indicator-tag .remove-indicator:hover {
    opacity: 1;
}

/* å…¨å±€æ•°æ®é€‰æ‹©å™¨æ ·å¼ */
.global-data-checkbox:checked + label {
    font-weight: bold;
    color: #007bff;
}

.selected-count {
    font-weight: bold;
}

.remark-input {
    font-family: 'Courier New', monospace;
    font-size: 12px;
}

.remark-input[readonly] {
    background-color: #f8f9fa;
}

.char-count {
    font-weight: bold;
    color: #6c757d;
}

.char-count.warning {
    color: #ffc107;
}

.char-count.danger {
    color: #dc3545;
}

.mode-indicator {
    font-size: 10px;
    color: #6c757d;
}

.wallet-row:hover {
    background-color: #f8f9fa;
}

.min-width-0 {
    min-width: 0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .wallet-avatar {
        width: 24px;
        height: 24px;
        font-size: 10px;
    }
    
    .data-chip {
        font-size: 9px;
        padding: 1px 4px;
    }
    
    .remark-input {
        font-size: 11px;
    }
}
</style>

<script>
// æ ‡ç­¾é…ç½®
const LABEL_CONFIG = {
    "ç‹™å‡»é’±åŒ…": { short: "ç‹™å‡»", emoji: "ğŸ¯", group: "none" },
    "é’“é±¼é’±åŒ…": { short: "é’“é±¼", emoji: "ğŸ£", group: "none" },
    "æ–°é’±åŒ…": { short: "æ–°", emoji: "ğŸ†•", group: "none" },
    "å•ä¸€å¸é’±åŒ…": { short: "å•å¸", emoji: "", group: "none" },
    "å†…ç›˜é€‰æ‰‹": { short: "å†…ç›˜", emoji: "ğŸ¦", group: "none" },
    "æ–°å…´èªæ˜äº¤æ˜“è€…": { short: "èªæ˜", emoji: "ğŸ§ ", group: "none" },
    "é¡¶çº§å¸topåœ°å€": { short: "é¡¶çº§", emoji: "ğŸ‘‘", group: "none" },
    "ä»£å¸é¦–æ‰¹æŒæœ‰è€…": { short: "é¦–æ‰¹", emoji: "ğŸ¥‡", group: "none" },
    "é«˜é¢‘äº¤æ˜“è€…": { short: "é«˜é¢‘", emoji: "", group: "äº¤æ˜“é¢‘ç‡" },
    "ä½é¢‘äº¤æ˜“è€…": { short: "ä½é¢‘", emoji: "", group: "äº¤æ˜“é¢‘ç‡" },
    "ä¼‘çœ äº¤æ˜“è€…": { short: "ä¼‘çœ ", emoji: "", group: "äº¤æ˜“é¢‘ç‡" },
    "æ³¢æ®µåœ£æ‰‹": { short: "æ³¢æ®µ", emoji: "ğŸ“ˆ", group: "none" },
    "åšå¸‚å•†": { short: "åšå¸‚", emoji: "ğŸ”„", group: "none" },
    "æš´å‡»å°å­": { short: "æš´å‡»", emoji: "ğŸ’¥", group: "none" }
};

// å…¨å±€çŠ¶æ€
let selectedDataIndicators = {}; // {address: [{type, period, value, label}]}
let remarkModes = {}; // {address: 'auto'|'manual'}
let preserveRemarks = '{{ preserve_remarks or "append" }}';
let globalDataSelection = []; // å…¨å±€æ•°æ®é€‰æ‹©

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeRemarkInputs();
    updateDataChipStyles();
    updateAllRemarks();
    initializeGlobalSelection();
});

function initializeGlobalSelection() {
    // ç›‘å¬å…¨å±€æ•°æ®é€‰æ‹©å™¨
    document.querySelectorAll('.global-data-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateGlobalSelection);
    });
}

function updateGlobalSelection() {
    const checkboxes = document.querySelectorAll('.global-data-checkbox:checked');
    const selectedCount = checkboxes.length;
    
    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
    document.getElementById('selectedCount').textContent = selectedCount;
    
    // é™åˆ¶æœ€å¤š3ä¸ª
    if (selectedCount >= 3) {
        document.querySelectorAll('.global-data-checkbox:not(:checked)').forEach(cb => {
            cb.disabled = true;
        });
    } else {
        document.querySelectorAll('.global-data-checkbox').forEach(cb => {
            cb.disabled = false;
        });
    }
    
    // æ›´æ–°å…¨å±€é€‰æ‹©æ•°ç»„
    globalDataSelection = Array.from(checkboxes).map(cb => cb.value);
}

function clearGlobalSelection() {
    document.querySelectorAll('.global-data-checkbox').forEach(cb => {
        cb.checked = false;
        cb.disabled = false;
    });
    globalDataSelection = [];
    updateGlobalSelection();
}

function applyGlobalSelection() {
    if (globalDataSelection.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åº”ç”¨çš„æ•°æ®æŒ‡æ ‡');
        return;
    }
    
    // åº”ç”¨åˆ°æ‰€æœ‰é’±åŒ…
    document.querySelectorAll('.wallet-row').forEach(row => {
        const address = row.dataset.address;
        selectedDataIndicators[address] = [];
        
        globalDataSelection.forEach(selection => {
            const [type, period] = selection.split('_');
            const dataChip = row.querySelector(`.data-chip[data-type="${type}"][data-period="${period}"]`);
            
            if (dataChip) {
                const value = parseFloat(dataChip.dataset.value || 0);
                const label = dataChip.textContent.trim();
                
                selectedDataIndicators[address].push({
                    type,
                    period,
                    value,
                    label: label.replace(':', '')
                });
            }
        });
        
        updateDataIndicatorsDisplay(address);
        updateRemark(address);
    });
    
    alert(`å·²åº”ç”¨ ${globalDataSelection.length} ä¸ªæ•°æ®æŒ‡æ ‡åˆ°æ‰€æœ‰é’±åŒ…`);
}

function initializeRemarkInputs() {
    document.querySelectorAll('.remark-input').forEach(input => {
        const address = input.dataset.address;
        remarkModes[address] = 'auto';
        selectedDataIndicators[address] = [];
        
        input.addEventListener('input', function() {
            updateCharCount(this);
        });
        
        updateCharCount(input);
    });
}

function updateDataChipStyles() {
    document.querySelectorAll('.data-chip[data-value]').forEach(chip => {
        const value = parseFloat(chip.dataset.value);
        const type = chip.dataset.type;
        
        // æ ¹æ®æ•°å€¼è®¾ç½®æ ·å¼
        if (type === 'win_rate') {
            if (value >= 60) {
                chip.classList.add('positive');
            } else if (value <= 30) {
                chip.classList.add('negative');
            }
        } else if (type === 'pnl' || type === 'roi') {
            if (value > 0) {
                chip.classList.add('positive');
            } else if (value < 0) {
                chip.classList.add('negative');
            }
        }
    });
}

function updateDataIndicatorsDisplay(address) {
    const container = document.querySelector(`.selected-data-indicators[data-address="${address}"]`);
    const indicators = selectedDataIndicators[address] || [];
    
    container.innerHTML = indicators.map(indicator => `
        <span class="data-indicator-tag" 
              onclick="removeDataIndicator('${address}', '${indicator.type}', '${indicator.period}')">
            ${indicator.label}
            <i class="fas fa-times remove-indicator"></i>
        </span>
    `).join('');
}

function removeDataIndicator(address, type, period) {
    if (selectedDataIndicators[address]) {
        selectedDataIndicators[address] = selectedDataIndicators[address].filter(
            item => !(item.type === type && item.period === period)
        );
        
        updateDataIndicatorsDisplay(address);
        updateRemark(address);
    }
}

// ç”Ÿæˆå¤‡æ³¨ï¼šé’±åŒ…å‰4ä½-æ•°æ®æ ‡ç­¾-å…¶ä»–æ ‡ç­¾
function generateRemark(address, useEmoji = true) {
    // 1. é’±åŒ…å‰4ä½
    const walletPrefix = address.slice(0, 4);
    
    // 2. æ•°æ®æ ‡ç­¾
    const indicators = selectedDataIndicators[address] || [];
    let dataRemark = '';
    if (indicators.length > 0) {
        dataRemark = indicators.map(ind => {
            let shortLabel = ind.label.replace(/[:\s]/g, '');
            // è¿›ä¸€æ­¥ç¼©çŸ­æ ‡ç­¾
            shortLabel = shortLabel.replace(/7D|30D/g, '').replace(/èƒœç‡|æ”¶ç›Š|ROI/g, '');
            return ind.period.toUpperCase() + shortLabel;
        }).join(',');
    }
    
    // 3. è·å–ç³»ç»Ÿæ ‡ç­¾
    const autoTagElements = document.querySelectorAll(`tr[data-address="${address}"] .auto-tag`);
    const autoTags = Array.from(autoTagElements).map(el => el.dataset.tag);
    
    // ç”Ÿæˆæ ‡ç­¾å¤‡æ³¨
    let tagRemark = '';
    if (autoTags.length > 0) {
        tagRemark = autoTags.map(tag => {
            const config = LABEL_CONFIG[tag];
            if (config) {
                // æŸäº›æ ‡ç­¾ä¸ç”¨emoji
                if (config.emoji === "") {
                    return config.short;
                } else {
                    return useEmoji ? config.emoji + config.short : config.short;
                }
            }
            return tag;
        }).join('-');
    }
    
    // 4. æ£€æŸ¥å¤§é¢æŒä»“
    const input = document.querySelector(`input[data-address="${address}"].remark-input`);
    const balanceMillions = parseFloat(input.dataset.balanceMillions || 0);
    const hasLargeHolding = input.dataset.hasLargeHolding === 'true';
    
    let balanceTag = '';
    if (hasLargeHolding && balanceMillions >= 0.1) {
        balanceTag = `${balanceMillions.toFixed(1)}M`;
    }
    
    // 5. ç»„åˆå¤‡æ³¨ï¼šé’±åŒ…å‰4ä½-æ•°æ®æ ‡ç­¾-å…¶ä»–æ ‡ç­¾-æŒä»“æ ‡ç­¾
    let parts = [walletPrefix];
    
    if (dataRemark) parts.push(dataRemark);
    if (tagRemark) parts.push(tagRemark);
    if (balanceTag) parts.push(balanceTag);
    
    let finalRemark = parts.join('-');
    
    // 6. å¤„ç†åŸå§‹å¤‡æ³¨
    const originalRemark = input ? input.dataset.originalRemark || '' : '';
    
    if (originalRemark) {
        if (preserveRemarks === 'overwrite') {
            // ä¿æŒå½“å‰é€»è¾‘
        } else if (preserveRemarks === 'append') {
            finalRemark = finalRemark + (finalRemark && originalRemark ? '-' : '') + originalRemark;
        } else if (preserveRemarks === 'prepend') {
            finalRemark = originalRemark + (finalRemark && originalRemark ? '-' : '') + finalRemark;
        }
    }
    
    // 7. é•¿åº¦é™åˆ¶
    if (finalRemark.length > 80) {
        finalRemark = finalRemark.slice(0, 77) + '...';
    }
    
    return finalRemark;
}

function updateRemark(address) {
    if (remarkModes[address] === 'manual') return;
    
    const input = document.querySelector(`input[data-address="${address}"].remark-input`);
    if (input) {
        input.value = generateRemark(address, true);
        updateCharCount(input);
    }
}

function updateAllRemarks() {
    Object.keys(remarkModes).forEach(address => {
        if (remarkModes[address] === 'auto') {
            updateRemark(address);
        }
    });
}

function toggleRemarkMode(address) {
    const input = document.querySelector(`input[data-address="${address}"].remark-input`);
    const modeIndicator = input.closest('.remark-container').querySelector('.mode-indicator');
    const editBtn = input.closest('.remark-container').querySelector('.btn');
    
    if (remarkModes[address] === 'auto') {
        // åˆ‡æ¢åˆ°æ‰‹åŠ¨æ¨¡å¼
        remarkModes[address] = 'manual';
        input.readOnly = false;
        input.classList.remove('bg-light');
        modeIndicator.textContent = 'æ‰‹åŠ¨æ¨¡å¼';
        editBtn.innerHTML = '<i class="fas fa-lock"></i>';
        editBtn.title = 'é”å®šä¸ºè‡ªåŠ¨';
        input.focus();
    } else {
        // åˆ‡æ¢åˆ°è‡ªåŠ¨æ¨¡å¼
        remarkModes[address] = 'auto';
        input.readOnly = true;
        input.classList.add('bg-light');
        modeIndicator.textContent = 'è‡ªåŠ¨æ¨¡å¼';
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.title = 'ç¼–è¾‘/é”å®š';
        updateRemark(address);
    }
}

function updateCharCount(input) {
    const length = input.value.length;
    const counter = input.closest('.remark-container').querySelector('.char-count');
    
    counter.textContent = `${length}/80`;
    counter.className = 'char-count';
    
    if (length > 75) {
        counter.classList.add('danger');
    } else if (length > 65) {
        counter.classList.add('warning');
    }
}

function copyAddress(address) {
    navigator.clipboard.writeText(address).then(() => {
        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        const toast = document.createElement('div');
        toast.className = 'alert alert-success alert-dismissible fade show position-fixed';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
        toast.innerHTML = `
            <i class="fas fa-check me-2"></i>åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) toast.remove();
        }, 3000);
    });
}

function exportResults() {
    const results = [];
    
    document.querySelectorAll('#walletAnalysisTable tbody tr').forEach(row => {
        const address = row.dataset.address;
        const balanceElement = row.querySelector('.balance-amount');
        const balance = balanceElement ? balanceElement.textContent : '';
        
        const autoTags = Array.from(row.querySelectorAll('.auto-tag')).map(tag => tag.textContent.trim());
        const remark = row.querySelector('.remark-input').value;
        
        // è·å–æ•°æ®
        const walletData = getWalletData(address);
        
        results.push({
            address,
            balance,
            win_rate_7d: walletData.win_rate_7d || 0,
            pnl_7d: walletData.pnl_7d || 0,
            roi_7d: walletData.roi_7d || 0,
            win_rate_30d: walletData.win_rate_30d || 0,
            pnl_30d: walletData.pnl_30d || 0,
            roi_30d: walletData.roi_30d || 0,
            autoTags: autoTags.join(', '),
            remark
        });
    });
    
    // è½¬æ¢ä¸ºCSV
    const headers = ['é’±åŒ…åœ°å€', 'æŒä»“ä»·å€¼', '7Dèƒœç‡%', '7Dæ”¶ç›Š', '7D ROI%', '30Dèƒœç‡%', '30Dæ”¶ç›Š', '30D ROI%', 'ç³»ç»Ÿæ ‡ç­¾', 'ç”Ÿæˆå¤‡æ³¨'];
    const csvContent = [
        headers.join(','),
        ...results.map(row => [
            row.address,
            `"${row.balance}"`,
            `"${row.win_rate_7d}%"`,
            `"${row.pnl_7d}"`,
            `"${row.roi_7d}%"`,
            `"${row.win_rate_30d}%"`,
            `"${row.pnl_30d}"`,
            `"${row.roi_30d}%"`,
            `"${row.autoTags}"`,
            `"${row.remark}"`
        ].join(','))
    ].join('\n');
    
    // ä¸‹è½½æ–‡ä»¶
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `wallet_analysis_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}