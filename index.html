<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>gmgnå¤‡æ³¨å·¥å…·</title>
<style>
  body { font-family: Arial, sans-serif; background: #111; color: #eee; padding: 20px; }
  input, button { padding: 6px; margin: 5px; }
  textarea { width: 100%; height: 300px; background: #222; color: #0f0; padding: 10px; }
</style>
</head>
<body>
<h2>gmgnå¤‡æ³¨å·¥å…·</h2>

<label>ä»£å¸ CAï¼š</label>
<input id="ca" type="text" placeholder="è¾“å…¥CAåœ°å€" size="60"><br>
<label>ä»£å¸åç§°ï¼š</label>
<input id="caName" type="text" placeholder="è¾“å…¥ä»£å¸åç§°" size="30"><br>
<button onclick="runTool()">å¼€å§‹è·å–</button>

<h3>ç»“æœ JSON</h3>
<textarea id="output"></textarea><br>
<button onclick="copyOutput()">å¤åˆ¶ JSON</button>

<script>
async function fetchAPI(url) {
    const finalUrl = "https://corsproxy.io/?" + encodeURIComponent(url);
    const res = await fetch(finalUrl);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
}

function getEmoji(tagList) {
    const hasFish = tagList.some(t => t.includes("suspectedPhishingWallet"));
    const hasDiamond = tagList.some(t => t.includes("diamondHands"));
    if (hasFish && hasDiamond) return "ğŸ ";
    if (hasFish) return "ğŸŸ";
    if (hasDiamond) return "ğŸ’";
    return "";
}

async function runTool() {
    const ca = document.getElementById("ca").value.trim();
    const caName = document.getElementById("caName").value.trim();
    if (!ca || !caName) {
        alert("è¯·å¡«å†™CAå’Œä»£å¸åç§°");
        return;
    }
    try {
        const timestamp = Date.now();

        // Top Holders
        const holdersUrl = `https://www.okx.com/priapi/v1/dx/market/v2/holders/ranking-list?chainId=501&tokenAddress=${ca}&t=${timestamp}`;
        const holdersData = await fetchAPI(holdersUrl);
        let holdersList = holdersData.data?.slice(0,100) || [];
        holdersList = holdersList
            .filter(h => h.boughtAmount !== "")
            .map((h, idx) => ({
                address: h.holderWalletAddress,
                name: `${caName}-top${idx+1}`,
                pic: getEmoji(h.tagList || []),
                topRank: idx+1
            }));

        // Top Traders
        const tradersUrl = `https://web3.okx.com/priapi/v1/dx/market/v2/pnl/top-trader/ranking-list?chainId=501&tokenContractAddress=${ca}&t=${timestamp}`;
        const tradersData = await fetchAPI(tradersUrl);
        let tradersList = tradersData.data?.slice(0,100) || [];
        tradersList = tradersList.map(t => ({
            address: t.holderWalletAddress,
            profit: (t.realizedProfit/1000).toFixed(2) + "k",
            pic: getEmoji(t.tagList || [])
        }));

        // åˆå¹¶å»é‡
        const resultMap = new Map();

        holdersList.forEach(h => {
            resultMap.set(h.address, {
                address: h.address,
                name: h.name,
                pic: h.pic,
                topRank: h.topRank
            });
        });

        tradersList.forEach(t => {
            if (resultMap.has(t.address)) {
                let item = resultMap.get(t.address);
                item.name = `${caName}-ç›ˆåˆ©${t.profit}-top${item.topRank}`;
                item.pic = item.pic || t.pic;
            } else {
                resultMap.set(t.address, {
                    address: t.address,
                    name: `${caName}-ç›ˆåˆ©${t.profit}`,
                    pic: t.pic
                });
            }
        });

        const finalResult = Array.from(resultMap.values()).map(({address,name,pic})=>({address,name,pic}));

        document.getElementById("output").value = JSON.stringify(finalResult, null, 2);
    } catch (err) {
        console.error(err);
        alert("è¯·æ±‚å¤±è´¥ï¼š" + err.message);
    }
}

function copyOutput() {
    const text = document.getElementById("output").value;
    navigator.clipboard.writeText(text).then(()=>alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));
}
</script>
</body>
</html>
